#
# This file is a Makefile for HOSTIP.  If it has the name "Makefile.in"
# then it is a template for a Makefile;  to generate the actual Makefile,
# run "./configure", which is a configuration script generated by the
# "autoconf" program (constructs like "@foo@" will get replaced in the
# actual Makefile.
#

PACKAGE =		@PACKAGE_NAME@
VERSION =		@PACKAGE_VERSION@
DISTNAME =		${PACKAGE}-${VERSION}
DDISTNAME =		${PACKAGE}-data

DISTDIR	=		../export
FTPDIR	=		../ftp
EM	=		astroem
JSFITSIO=		$(EM)/jsfitsio
ALLIN1	=	 	js9-allinone

#----------------------------------------------------------------
# Things you can change to personalize the Makefile for your own
# site (you can make these changes in either Makefile.in or
# Makefile, but changes to Makefile will get lost if you re-run
# the configuration script).
#----------------------------------------------------------------

# Default top-level directories in which to install architecture-
# specific files (exec_prefix) and machine-independent files such
# as scripts (prefix).  The values specified here may be overridden
# at configure-time with the --exec-prefix and --prefix options
# to the "configure" script.

prefix =		@prefix@
exec_prefix =		@exec_prefix@

# The following definition can be set to non-null for special systems
# like AFS with replication.  It allows the pathnames used for installation
# to be different than those used for actually reference files at
# run-time.  INSTALL_ROOT is prepended to $prefix and $exec_prefix
# when installing files.
INSTALL_ROOT =

# Directory in which to install the .a or .so binary for the TPOS library:
LIB_INSTALL_DIR =	$(INSTALL_ROOT)$(exec_prefix)/lib

# Directory in which to install the program wish:
BIN_INSTALL_DIR =	$(INSTALL_ROOT)$(exec_prefix)/bin

# Directory in which to install the include file tpos.h:
INCLUDE_INSTALL_DIR =	$(INSTALL_ROOT)$(prefix)/include

# Top-level directory for manual entries:
MAN_INSTALL_DIR =	$(INSTALL_ROOT)$(prefix)/man

# Directory in which to install manual entry for TPOS programs:
MAN1_INSTALL_DIR =	$(MAN_INSTALL_DIR)/man1

# Directory in which to install manual entries for TPOS's C library
# procedures:
MAN3_INSTALL_DIR =	$(MAN_INSTALL_DIR)/man3

# extra Libs required to link (e.g. socket libraries)
LIBS =            	@CFITSIOLIB@ @FUNLIB@ @PNGLIB@ @EXTRA_LIBS@ -lm

# includes
INCS =			-I. @CFITSIOINC@ @FUNINC@ @PNGINC@ \
			-I./util -I./$(JSFITSIO)

# To change the compiler switches, for example to change from -O
# to -g, change the following line:
CFLAGS = 		@CFLAGS@

# To add ld switches, change the following line:
LDFLAGS =		@LDFLAGS@

# Some versions of make, like SGI's, use the following variable to
# determine which shell to use for executing commands:
SHELL =			/bin/sh

# There are just too many different versions of "install" around;
# better to use the install-sh script that comes with the distribution,
# which is slower but guaranteed to work.

INSTALL = 		@srcdir@/install-sh -c
INSTALL_PROGRAM =	${INSTALL}
INSTALL_DATA =		${INSTALL} -m 644

#----------------------------------------------------------------
# The information below is modified by the configure script when
# Makefile is generated from Makefile.in.  You shouldn't normally
# modify any of this stuff by hand.
#----------------------------------------------------------------

AC_FLAGS =		@DEFS@
RANLIB =		@RANLIB@

#----------------------------------------------------------------
# The information below should be usable as is.  The configure
# script won't modify it and you shouldn't need to modify it
# either.
#----------------------------------------------------------------
RM =		rm -rf

CP =		cp -p

CC =		@CC@

CC_SW =		${CFLAGS} ${AC_FLAGS} ${INCS}

DEPEND_SW = 	${CFLAGS} -I. ${AC_FLAGS}

# type of backend server (or none)
HELPER =	@HELPER@
USEHELPER =	@USEHELPER@

# which library
FITSLIB =	@FITSLIB@

# where the web files go on your site
WEBDIR =   	@WEBDIR@
CGIDIR =   	@CGIDIR@
CGIURL =   	@CGIURL@
CGIXPATH =   	@CGIXPATH@
# this is for SAO install only ... I think!
SAODIR =	@SAODIR@

WEBDIRS	=	plugins params js css images

BEDIRS =	node_modules analysis-plugins analysis-wrappers

WEBFILES =	js9.js js9.min.js \
		js9support.js js9support.min.js js9support.css js9plugins.js \
		js9support.txt js9.css fitsy.js fitsy.min.js \
		$(ALLIN1).js $(ALLIN1).css \
		js9Msg.js js9Helper.js js9Prefs-default.json \
		js9Prefs.json favicon.ico index.html

SAOFILES =	index.html

CSSFILES =	css/jquery.contextMenu.css css/dhtmlwindow.css  \
		css/tabcontent.css

PLCSSFILES =	plugins/core/blend.css plugins/core/blink.css \
		plugins/core/colorbar.css plugins/core/cube.css \
		plugins/core/imarith.css plugins/core/mef.css \
		plugins/core/mousetouch.css

JSFILES =	js/jquery.min.js js/jquery-ui.min.js js/jquery.contextMenu.min.js js/jquery.flot.min.js js/jquery.flot.errorbars.min.js js/jquery.flot.navigate.min.js js/jquery.flot.selection.min.js js/flot-zoom.min.js js/sprintf.min.js js/dhtmlwindow.min.js js/dhtmlwindow_blurb.js js/fabric.min.js js/pako_inflate.min.js js/FileSaver.min.js js/canvas-toBlob.js js/tabcontent.js js/astroem.js js/arrive.min.js js/jquery.doubletap.min.js js/jquery.flot.axislabels.js js/spin.js js/ElementQueries.js js/ResizeSensor.js js/gaussblur.js js/imagefilters.js js/jquery.ui.touch-punch.js

PLUGINFILES =	plugins/archive/archive.js \
		plugins/fitsy/binning.js \
		plugins/core/blend.js \
		plugins/core/blink.js \
		plugins/core/colorbar.js \
		plugins/core/cube.js \
		plugins/core/imarith.js \
		plugins/core/mef.js \
		plugins/core/mousetouch.js \
		plugins/core/prefs.js \
		plugins/imexam/imexam.js \
		plugins/imexam/encircled.js \
		plugins/imexam/pixtable.js \
		plugins/imexam/radproj.js \
		plugins/imexam/reghist.js \
		plugins/imexam/regstat.js \
		plugins/imexam/xyproj.js \
		plugins/imexam/3dplot.js \
		plugins/imexam/contour.js

PREFFILES =	js9Prefs.json

CGIFILES =	js9Helper.cgi

WEBHELP	=	help

WEBDATA	=	fits png kes75 m13

# public web site
WEBSITE =	http://js9.si.edu
# local test web site
LWEBSITE=	http://localhost/~eric/

SRCS =		tpos.c js9helper.c

PROGS =		tpos js9helper

JS9TESTS =	js9Test.js js9Test.html js9Tests

TESTPROGS =	pngdisp cimtest

INCLUDES =	js9helper.h

SCRIPTS =	funhist2flot funcnts2flot fits2png 

SCRIPTS2 =	js9

MFILES =	Makefile Makefile.in config.guess config.sub \
		configure configure.ac install-sh js9helper.pc.in js9.in \
		saoconfig saoprefs.sed nnode mkallinone mkhelper mkjs9 \
		util astroem js9Helper-default.cgi js9load README

UTILLIB	=	libutil.a

TPOSOBJS =	tpos.o @CFITSIOOBJS@

CIMTESTOBJS =	cimtest.o @CFITSIOOBJS@

ifeq ($(FITSLIB), cfitsio)
HELPEROBJS =	js9helper.o jsfitsio.o
else
HELPEROBJS =	js9helper.o
endif

UTILOBJS = 	$(wildcard util/*.o)

all:		progs helper

ifeq ($(USEHELPER), yes)
progs:		$(PROGS)
else
progs:	
endif

testall:	$(TESTPROGS)

All:		all testall

tpos:		$(UTILLIB) $(TPOSOBJS)
		$(CC) $(LDFLAGS) $(TPOSOBJS) $(UTILLIB) -o $@ $(LIBS)

js9helper:	$(UTILLIB) $(HELPEROBJS)
		$(CC) $(LDFLAGS) $(HELPEROBJS) -o $@ $(UTILLIB) $(LIBS)

pngdisp:	pngdisp.o
		$(CC) $(LDFLAGS) pngdisp.o -o $@ $(LIBS)

cimtest:	$(CIMTESTOBJS)
		$(CC) $(LDFLAGS) $(CIMTESTOBJS) -o $@ $(LIBS)

prefs:		FORCE
		@(echo "copying default preferences to js9Prefs.json"; \
		  cp -p js9Prefs-default.json js9Prefs.json;)

saoprefs:	FORCE
		@(echo "editing js9Prefs for SAO installations ..."; \
		sed -f saoprefs.sed < js9Prefs.json > js9Prefs-sao.json; \
		echo "editing helper file for SAO installations ..."; \
		./mkhelper "$(HELPER)" \
		"$(CGIDIR)" "$(CGIURL)" "$(CGIXPATH)" js9Prefs-sao.json;)

helper:		FORCE
		@(./mkhelper "$(HELPER)" \
		  "$(CGIDIR)" "$(CGIURL)" "$(CGIXPATH)"; \
		  if [ x"$(USEHELPER)" = x"yes" ]; then \
		    ./mkjs9 "$(WEBDIR)"; \
		  fi;)

nohelper:	FORCE
		@(./mkhelper none; \
		  ./mkjs9 "$(WEBDIR)")

nodejshelper:	FORCE
		@(./mkhelper nodejs; \
		  ./mkjs9 "$(WEBDIR)")


cgihelper:	FORCE prefs
		@(./mkhelper get "$(CGIDIR)" "$(CGIURL)" "$(CGIXPATH)"; \
		  ./mkjs9 "$(WEBDIR)")

js9:		FORCE
		@(if [ x"$(USEHELPER)" = x"yes" ]; then \
		    ./mkjs9 "$(WEBDIR)"; \
		  fi;)

js9support:	FORCE
		@(echo "remaking js9support ..."; \
		  echo "css files in js9support.css: " > js9support.txt; \
		  echo $(CSSFILES) >>  js9support.txt; \
		  cat $(CSSFILES)  >  js9support.css;  \
		  echo $(PLCSSFILES) >>  js9support.txt; \
		  cat $(PLCSSFILES)  >>  js9support.css;  \
		  echo "js files in js9support.js: " >> js9support.txt; \
		  echo $(JSFILES)  >> js9support.txt; \
		  cat $(JSFILES)   >  js9support.min.js; \
		  X=`echo "$(JSFILES)" | sed 's/\.min//g'`; \
		  cat $$X  > js9support.js; \
		  echo "plugin files in js9plugins.js: " >> js9support.txt; \
		  echo $(PLUGINFILES)  >> js9support.txt; \
		  cat $(PLUGINFILES)   >  js9plugins.js;)


js9min:		FORCE
		@(echo "remaking js9.min.js ..."; \
		  touch js9.js; minify js9.js; \
		  echo "remaking all in one ..."; \
		  mkallinone $(ALLIN1) $(VERSION))

fitsymin:	FORCE
		@(echo "remaking fitsy.min.js ..."; touch fitsy.js; minify fitsy.js)

refresh:	js9support fitsymin js9min

jslint:		FORCE
		@(jslint js9.js fitsy.js js9Helper.js js9Msg.js js9Test.js)

tar:		FORCE
		($(RM) config.cache; \
		cd ..; \
		tar cf - $(DISTNAME) | gzip -9 -c > $(DISTNAME).tar.gz)

install:	install-binaries install-scripts install-web

install-binaries: FORCE
	@(if [ x$(USEHELPER) = xyes ]; then \
	  echo "Installing programs ..."; \
	  for i in $(LIB_INSTALL_DIR) $(INCLUDE_INSTALL_DIR) $(BIN_INSTALL_DIR) ; \
	    do \
	    if [ ! -d $$i ] ; then \
		echo "making directory $$i"; \
		mkdir -p $$i; \
		chmod 755 $$i; \
		else true; \
		fi; \
	    done; \
	  for i in $(PROGS) ; \
	    do \
		if [ -f $$i.exe ] ; then \
		    echo "installing $$i.exe" ; \
		    $(INSTALL_PROGRAM) $$i.exe $(BIN_INSTALL_DIR)/$$i.exe ; \
		elif [ -f $$i ] ; then \
		    echo "installing $$i" ; \
		    $(INSTALL_PROGRAM) $$i $(BIN_INSTALL_DIR)/$$i ; \
		fi; \
	    done; \
	  else \
	    echo "nothing to install for 'binaries' (no helper configured)"; \
	  fi;)

install-scripts: $(SCRIPTS) $(SCRIPTS2)
	@(if [ x$(USEHELPER) = xyes ]; then \
	  echo "Installing scripts ..."; \
	  for i in $(BIN_INSTALL_DIR) ; \
	    do \
	    if [ ! -d $$i ] ; then \
		echo "making directory $$i"; \
		mkdir -p $$i; \
		chmod 755 $$i; \
		else true; \
		fi; \
	    done; \
	 for i in $(SCRIPTS) $(SCRIPTS2) ; \
	    do \
		if [ -f $$i ] ; then \
		    echo "installing $$i" ; \
		    $(INSTALL_PROGRAM) $$i $(BIN_INSTALL_DIR)/$$i ; \
		fi; \
	    done; \
	  else \
	    echo "nothing to install for 'scripts' (no helper configured)"; \
	  fi;)

install-web:		install-webdirs install-webfiles install-webcgi

install-webdirs:	FORCE
	@(echo "Installing web directories ..."; \
	 for i in $(WEBDIRS) $(WEBHELP); do \
	    if [ x$(WEBDIR) != x ]; then \
		mkdir -p $(WEBDIR); \
		if [ -d $$i ] ; then \
		    echo "installing web dir: $$i" ; \
		    tar cf - $$i | (cd $(WEBDIR); tar xf -); \
		fi; \
	    fi; \
         done; \
	 if [ x$(USEHELPER) = xyes ]; then \
	   echo "Installing backend helper dirs ..."; \
	   for i in $(BEDIRS); do \
		if [ -d $$i ] ; then \
		    echo "installing backend dir: $$i" ; \
		    tar cf - $$i | (cd $(WEBDIR); tar xf -); \
		fi; \
           done; \
	 fi;)

install-webfiles:	FORCE
	@(echo "Installing web files ..."; \
	if [ x$(WEBDIR) != x ]; then \
		mkdir -p $(WEBDIR); \
		if [ -f $(WEBDIR)/js9Prefs.json ] ; then \
		    echo "moving aside old js9Prefs.json" ; \
		    mv $(WEBDIR)/js9Prefs.json{,-old}; \
	        fi; \
	fi; \
	for i in $(PREFFILES) $(WEBFILES) js9*.html ; do\
	    if [ x$(WEBDIR) != x ]; then \
		if [ -d $$i ] ; then \
		    echo "installing web directory: $$i" ; \
		elif [ -f $$i ] ; then \
		    echo "installing web file: $$i" ; \
		fi; \
		tar cf - $$i | (cd $(WEBDIR); tar xf -); \
	    fi; \
        done;)

install-webcgi:	FORCE
	@(if [ -d "$(CGIDIR)" ]; then \
	    echo "Installing web CGI files ..."; \
	    for i in $(CGIFILES) ; do\
	        if [ -f $$i ]; then \
		    if [ -d $$i ] ; then \
		        echo "installing cgi directory: $$i" ; \
		    elif [ -f $$i ] ; then \
		        echo "installing cgi file: $$i" ; \
		    fi; \
		    tar cf - $$i | (cd $(CGIDIR); tar xf -); \
	        else \
		    echo "skipping cgi install: $$i"; \
	        fi; \
	    done; \
	else \
	    echo "nothing to install in cgi (no helper configured)"; \
	fi;)

install-webdata:	FORCE
	@(for i in $(WEBDATA) ; do\
	    if [ x$(WEBDIR) != x ]; then \
	        mkdir -p $(WEBDIR); \
		if [ -d $$i ] ; then \
		    echo "installing $$i" ; \
		    tar cf - $$i | (cd $(WEBDIR); tar xf -); \
		fi; \
	    fi; \
         done;)

install-sao:	saoprefs install-webcgi install-js9tests
		@(if [ -d "$(SAODIR)" ]; then \
		    for i in $(SAOFILES) ; \
		    do \
			if [ -f $$i ] ; then \
			    echo "installing file: $$i" ; \
		            $(CP) $$i $(SAODIR)/.; \
			fi; \
		    done; \
		  fi; \
		  echo "installing SAO js9Prefs.json"; \
		  $(CP) js9Prefs-sao.json $(WEBDIR)/js9Prefs.json; \
		  if [ -d js9debugextras ]; then \
		    echo "installing js9debugextras"; \
		    tar cf - js9debugextras | (cd $(WEBDIR); tar xf -); \
		  fi)

install-saoprefs:	saoprefs
		  @(echo "installing SAO js9Prefs.json"; \
		  $(CP) js9Prefs-sao.json $(WEBDIR)/js9Prefs.json;)

install-js9tests:	FORCE
		@(echo "installing js9tests ..."; \
		  tar cf - $(JS9TESTS) | (cd $(WEBDIR) && tar xf -))

install-smartx:	FORCE
		@(echo "installing smartx"; cd smartx; make install);

allinone:	FORCE
		@(mkallinone $(ALLIN1) $(VERSION))

gitprefs:	FORCE
		@(if [ -d .git ]; then \
                     git checkout -- js9Prefs-sao.json; \
		     git checkout -- js9Prefs.json; \
		  fi;)

release:	clean gitprefs
		(mkdir -p $(DISTDIR)/$(DISTNAME); \
	        touch $(DISTDIR)/foo; \
		tar cf - \
			 --exclude='node_modules/selenium-webdriver' \
			 --exclude='node_modules/socket.io_v[0-9]*' \
			 $(WEBFILES) $(WEBDIRS) $(BEDIRS) $(WEBHELP) \
			 $(JS9TESTS) js9*.html \
			 $(SRCS) $(INCLUDES) $(SCRIPTS) $(MFILES) |\
		(cd $(DISTDIR)/$(DISTNAME) && tar xf -); \
		cd $(DISTDIR) ; \
		tar cf - $(DISTNAME) | gzip -c > $(DISTNAME).tar.gz; \
		rm -rf foo $(DISTNAME))

release-data:	FORCE
		tar cf - $(WEBDATA) | gzip -c > $(DISTDIR)/$(DDISTNAME).tar.gz;

spell:		FORCE
		@(for f in index.html $(WEBHELP)/*.html; do \
			echo "spellcheck $$f ..."; \
			aspell -c $$f; \
		  done)

js9tests:	FORCE
		@(node js9Test.js --all)

js9tests-chrome:FORCE
		@(node js9Test.js --webpage $(LWEBSITE)/js9/js9Test.html --all --browser=chrome)

js9tests-firefox:FORCE
		@(node js9Test.js --webpage $(LWEBSITE)/js9/js9Test.html --all --browser=firefox)

ckwebsite:	FORCE
		@(got=`node js9Test.js --webpage $(WEBSITE)/js9/js9Test.html counts`; \
		if [ x"$$got" != x"countsTest.js [counts in regions]: success" ]; then \
		  echo "ERROR: there is a problem with js9.si.edu ..."; \
		  echo "return: $$got"; \
		else \
		  echo "OK"; \
		fi;)

clean:		FORCE
		@($(RM) *.a *.so *.dylib *.o *.exe core core.* errs *pure* \
			foo* *~ \#* TAGS *.E a.out errors \
			$(UTILLIB) $(PROGS) $(CGIFILES) $(TESTPROGS) \
			gmon.out *.pg *.bak  *js9Prefs.json-orig \
			config.info config.log ltest \
			js/*~ params/*~ \
			doc/*~ notes/*~ test/*~ help/*~ help/*.bak \
			analysis-wrappers/*~ analysis-plugins/*~ \
			plugins/*~ plugins/*/*~ \
			util/*.o util/*~ js9Tests/*~ \
			autom4te.cache a.out.dSYM tmp/*; \
			cd astroem && $(MAKE) clean;)

distclean:	clean
		$(RM) Makefile config.status config.cache config.log \
		$(PREFFILES)

maintainer-clean:: clean
		$(RM) config.status config.cache config.log \
		$(PREFFILES)

Makefile:	Makefile.in
		$(SHELL) config.status

make:		Makefile.in
		$(SHELL) config.status

depend:		FORCE
		makedepend -- $(DEPEND_SW) -- $(SRCS)

$(UTILLIB):	$(UTILOBJS)
		@(cd util; \
		env CC="$(CC)" CFLAGS="$(CC_SW)" make; \
		mv libutil.a ..)

tpos.o:		tpos.c
		$(CC) -c $(CC_SW) -o $@ $+

jsfitsio.o:	$(JSFITSIO)/jsfitsio.c
		$(CC) -c $(CC_SW) -o $@ $+

js9helper.o:	js9helper.c
		$(CC) -c $(CC_SW) -o $@ $+

pngdisp.o:	pngdisp.c
		$(CC) -c $(CC_SW) -o $@ $+

cimtest.o:	cimtest.c
		$(CC) -I ./astroem/jsfitsio -c $(CC_SW) -o $@ $+

configure:	configure.ac
		autoconf

errcheck:	FORCE
		@(egrep '[^x]error|warning|ld:|collect2:|make:' foo | \
		  egrep -v "^lex.*but not used"; true)

valgrind:	FORCE
		@(echo "see: https://developer.mozilla.org/en-US/docs/Mozilla/Testing/Valgrind"; echo "for Macs: valgrind --dsymutil=yes --show-mismatched-frees=no --leak-check=yes --track-origins=yes [prog] [args]";)

FORCE:

# DO NOT DELETE THIS LINE -- make depend depends on it.
